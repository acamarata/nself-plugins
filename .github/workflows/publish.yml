name: Publish to Registry

on:
  push:
    tags:
      - 'v*'
    branches:
      - main
    paths:
      - 'registry.json'
      - 'plugins/*/plugin.json'
      - '.workers/**'
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'Force registry sync'
        required: false
        default: 'false'
      deploy_worker:
        description: 'Deploy Cloudflare Worker'
        required: false
        default: 'false'

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate registry.json
        run: |
          # Check JSON syntax
          if ! jq empty registry.json 2>/dev/null; then
            echo "ERROR: registry.json is not valid JSON"
            exit 1
          fi

          # Validate against schema (with format support)
          npm install -g ajv-cli ajv-formats
          ajv validate -s registry-schema.json -d registry.json -c ajv-formats

      - name: Validate plugin manifests
        run: |
          for plugin in plugins/*/plugin.json; do
            if ! jq empty "$plugin" 2>/dev/null; then
              echo "ERROR: $plugin is not valid JSON"
              exit 1
            fi
            echo "Validated: $plugin"
          done

      - name: Check version consistency
        run: |
          for plugin_dir in plugins/*/; do
            plugin_name=$(basename "$plugin_dir")
            manifest_version=$(jq -r '.version' "$plugin_dir/plugin.json")
            registry_version=$(jq -r ".plugins.\"$plugin_name\".version" registry.json)

            if [[ "$manifest_version" != "$registry_version" ]]; then
              echo "WARNING: Version mismatch for $plugin_name"
              echo "  plugin.json: $manifest_version"
              echo "  registry.json: $registry_version"
            fi
          done

  publish:
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Update registry timestamp
        run: |
          # Update the 'lastUpdated' field in registry.json
          jq '.lastUpdated = (now | strftime("%Y-%m-%dT%H:%M:%SZ"))' registry.json > registry.tmp.json
          mv registry.tmp.json registry.json

      - name: Generate checksums
        run: |
          for plugin_dir in plugins/*/; do
            plugin_name=$(basename "$plugin_dir")
            checksum=$(tar -cf - "$plugin_dir" 2>/dev/null | sha256sum | cut -d' ' -f1)

            # Update checksum in registry.json
            jq --arg name "$plugin_name" --arg checksum "sha256:$checksum" \
              '(.plugins[$name].checksums.sha256) = $checksum' \
              registry.json > registry.tmp.json
            mv registry.tmp.json registry.json
          done

      - name: Commit registry updates
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add registry.json
          git commit -m "chore: Update registry timestamp and checksums" || true
          git push || true

      - name: Notify plugins.nself.org
        env:
          CLOUDFLARE_WORKER_SYNC_TOKEN: ${{ secrets.CLOUDFLARE_WORKER_SYNC_TOKEN }}
        run: |
          if [ -n "$CLOUDFLARE_WORKER_SYNC_TOKEN" ]; then
            response=$(curl -sf -X POST "https://plugins.nself.org/api/sync" \
              -H "Authorization: Bearer $CLOUDFLARE_WORKER_SYNC_TOKEN" \
              -H "Content-Type: application/json" \
              -d "{\"ref\": \"${{ github.ref }}\", \"sha\": \"${{ github.sha }}\"}" 2>&1) || true

            if echo "$response" | jq -e '.success' >/dev/null 2>&1; then
              echo "Registry synced successfully"
              echo "$response" | jq .
            else
              echo "Registry sync skipped or failed (this is OK if Worker is not deployed yet)"
              echo "$response"
            fi
          else
            echo "CLOUDFLARE_WORKER_SYNC_TOKEN not set - skipping Worker notification"
          fi

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          generate_release_notes: true
          files: |
            registry.json

  deploy-worker:
    needs: validate
    runs-on: ubuntu-latest
    # Deploy worker when .workers changes, or when manually triggered with deploy_worker=true
    if: |
      (github.event_name == 'push' && github.event.head_commit != null && contains(toJSON(github.event.head_commit.modified), '.workers/')) ||
      (github.event_name == 'push' && github.event.head_commit != null && contains(toJSON(github.event.head_commit.added), '.workers/')) ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_worker == 'true') ||
      startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install wrangler
        run: npm install -g wrangler

      - name: Install Worker dependencies
        working-directory: .workers/plugins-registry
        run: npm install

      - name: Deploy Worker to Cloudflare
        working-directory: .workers/plugins-registry
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          if [ -n "$CLOUDFLARE_API_TOKEN" ]; then
            echo "Deploying Worker to production..."
            wrangler deploy --env production
            echo "Worker deployed successfully!"
          else
            echo "CLOUDFLARE_API_TOKEN not set - skipping Worker deployment"
            echo "To deploy manually, run: cd .workers/plugins-registry && ./deploy.sh"
          fi

      - name: Verify Worker deployment
        run: |
          sleep 5
          response=$(curl -sf https://plugins.nself.org/health 2>&1) || true
          if echo "$response" | jq -e '.status == "healthy"' >/dev/null 2>&1; then
            echo "Worker is healthy!"
            echo "$response" | jq .
          else
            echo "Could not verify worker health (may take a few minutes to propagate)"
          fi
